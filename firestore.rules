rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =============================================================
    // FONCTION D'AIDE :
    // Vérifie si l'utilisateur connecté est un administrateur.
    // =============================================================
    function isAdmin() {
      // Pour que cela fonctionne, remplacez la ligne ci-dessous
      // par votre propre UID Firebase que vous trouverez dans la
      // section "Authentication" de la console Firebase.
      //
      // Exemple : return request.auth.uid == 'AbcdeF1G2hI3jK4lM5n6oP7qR8sT9';
      //
      let adminUIDs = [
        'REMPLACEZ_CECI_PAR_VOTRE_UID_FIREBASE'
      ];
      return request.auth.uid in adminUIDs;
    }
    
    // =============================================================
    // COLLECTIONS PUBLIQUES
    // Tout le monde peut lire ces données.
    // Seuls les administrateurs peuvent les modifier.
    // =============================================================
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // =============================================================
    // SOUS-COLLECTION D'AVIS
    // Tout le monde peut lire les avis.
    // Seuls les utilisateurs connectés peuvent en créer.
    // =============================================================
    match /products/{productId}/reviews/{reviewId} {
       allow read: if true;
       allow create: if request.auth != null;
       allow update, delete: if false; // Personne ne peut modifier/supprimer les avis
    }

    // =============================================================
    // DONNÉES UTILISATEUR
    // Les utilisateurs ne peuvent accéder qu'à leurs propres documents.
    // =============================================================
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth != null;
    }
    
    // =============================================================
    // COMMANDES
    // Les utilisateurs ne peuvent lire que leurs propres commandes.
    // La création est gérée par le backend sécurisé (fonctions).
    // =============================================================
    match /orders/{orderId} {
        allow read: if request.auth.uid == resource.data.userId;
        allow create: if request.auth != null; // La création est limitée au backend
        allow update, delete: if false;
    }
  }
}
